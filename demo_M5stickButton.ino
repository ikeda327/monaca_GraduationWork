#include "M5StickCPlus.h"

#include <SoftwareSerial.h>


#define COMM_TX 26
#define COMM_RX 25

const String image = "000000000000000000000000000000000000000000000000000000000000000000000000000000000000111000000001000000010000000000000010000001011000000000100010001110001000000001010000000000000000000010000001100011000000000000101000000001100000000000110000010000000101100000000000000000000000000000000000000000000000000000000000000000002"
                     "000000000000000000000000000000000000000000000000000000000000000000000000000000000000110000000001000000010000000000000110000001010000000000110011000011111100000000001100000000000000000001001110000001110000000000011100000001100000000000110000010000000100100000000000000000000000000000000000000000000000000000000000000000002"
                     //                   "000000000000000000000000000000000000000000000000000000000000000000000000000000000000110000000001000000010000000000000110000001100000000000011011011000011110000000100110000100000000000001111000000010011011000000001100000001110000000000110000010000000110110000000000000000000000000000000000000000000000000000000000000000002"
                     //                   "000000000000000000000000000000000000000000000000000000000000000000000000000000000001110000000001000000010000000000000111000001100000000000011100000110000111000000100001000010000000000000100000000000001110000000000100000001110000000000110000010000000010011000000000000000000000000000000000000000000000000000000000000000002"
                     //                   "000000000000000000000000000000000000000000000000000000000000000000000000000000000001100000000001000000010000000000000101000011000100001111111111000001100001100000100000110001100000000000100100000011111110000010000010000001110000000000110000010000000011001100000000000000000000000000000000000000000000000000000000000000002"
                     //                   "000000000000000000000000000000000000000000000000000000000000000000000000000000000011100000000001000000010000000000000101100011110000111111111111110000010000100000000000001000110000000000010000011111111111110000100010000001110000000000110000010000000001000110000000000000000000000000000000000000000000000000000000000000002"
                     //                   "000000000000000000000000000000000000000000000000000000000000000000000000000000000011100000000001000000010000000000001100100011100011111111111111111100001000010000000000000111011000000000010000111111111111111100010000000000010000000000110000011000000001100111000000000000000000000000000000000000000000000000000000000000002"
                     "000000000000000000000000000000000000000000000000000000000000000000000000000000000111100000000001000000010000000000001100010011000111111000000001111110000000000000000000000000001110000000001011111111000111111110001011000010010000000000110000000000000001100011000000000000000000000000000000000000000000000000000000000000002"
                     "000000000000000000000000000000000000000000000000000000000000000000000000000000001111100000000001000000010000000000001100010010011111100000000000011111000000000100000000000000000000000000001111111000000000011111000011000010010000000000110000010000000000100001100000000000000000000000000000000000000000000000000000000000002"
                     "000000000000000000000000000000000000000000000000000000000000000000000000000000001101100000000001000000010000000000001000001000111110000001111000000111000000000010001000000000000000000000001111100000111000000111110011000000010000000000010000000000000000110000110000000000000000000000000000000000000000000000000000000000003"
                     "888888888888888888888888888888888888888888888888888888888888888888";

SoftwareSerial sSerial;

void setup() {
  M5.begin();  // Initialize the M5StickC-Plus object. M5StickC-Plus
  M5.Lcd.setTextColor(YELLOW);  // Set the font color to yellow.
  M5.Lcd.setTextSize(2);  // Set the font size to 2.
  M5.Lcd.setTextColor(RED);

  Serial.begin(115200);
  Serial.println("start");

  sSerial.begin(9600, SWSERIAL_8N1, COMM_RX, COMM_TX, false);         // シリアル通信の開始(ボーレート9600bps)

  pinMode(M5_LED, OUTPUT);

  digitalWrite(M5_LED, HIGH);
}

void moveDemo() {
  int index = 0;
  Serial.println("a pressed");
  Serial.print("length:");
  Serial.println(image.length());

  while (index < image.length()) {
    int i = image.charAt(index);
    sSerial.write(i);
    digitalWrite(M5_LED, i == '1' ? LOW : HIGH);

    index++;
    int inner = 4000;
    while (!sSerial.available()) {
      //        Serial.print(".");
      inner --;
      delay(8);
      if (inner < 0) {
        Serial.println("abort!");
        // return;
        break;
      }
    }
    Serial.write(sSerial.read());
  }
  Serial.println("finish");
}

void loop() {
  M5.update();  // Read the press state of the key.
  if (M5.BtnA.wasReleased()) {  // If the button A is pressed.
    M5.Lcd.print('A');
    moveDemo();
  } else if (M5.BtnB.wasReleased()) {  // If the button B is pressed.
    M5.Lcd.print('B');
  } else if (M5.BtnB.wasReleasefor(700)) {  // The button B is pressed for 700ms.
    M5.Lcd.fillScreen(BLACK);  // Set BLACK to the background color.
    M5.Lcd.setCursor(0, 0);
  }
}
