<ons-page id="first-page">
    <ul class="tab-area">
        <li class="tab active">ホーム</li>
        <li class="tab">ペイント</li>
        <li class="tab">選択</li>
    </ul>

    <div class="panel-area">
        <div class="panel active">
            <div class="content" style="text-align: center; font-size: 90px; margin-top: 50px;">
                <p>B.Printer</p>
                <ons-button id="push-button" onclick="document.querySelector('#navigator').pushPage('2_detail.html')">
                    アプリの説明</ons-button>
            </div>
        </div>
        <div class="panel">
            <div>
                <div class="paint-canvas">
                    <canvas id="canvas"></canvas>
                </div>

                <div class="btn">
                    <ons-button id="pen-button">ペン</ons-button>
                    <ons-button id="eraser-button">消しゴム</ons-button>
                    <ons-button id="clear-button">全消去</ons-button>
                </div>
                <div class="btn_fin">
                    <ons-button id="btn_finish">完成</ons-button>
                </div>
            </div>
        </div>
        <div class="panel">
            <!-- 元画像 -->
            <div class="wrapper">
                <img id="photo" />
            </div>

            <div class="wrapper2">
                <canvas id="dst"></canvas>
            </div>

            <div class="slide">
                <input type="range" id="input" class="slider" value="" min="0" max="255" step="5">
                <label class="value">0</label>
                <ons-button class="reload" id="reload_btn">自動</ons-button>
            </div>

            <div class="btn_fin2">
                <ons-button id="btn_finish">完成</ons-button>
            </div>

            <div class="tabbar">
                <!-- <img src="images/search.png" />
                <img src="images/heart.png" /> -->
                <img src="images/camera.png" id="camera" onclick="snapPicture('camera')" />
                <img src="images/folda.png" id="galary" onclick="snapPicture('galary')" />
            </div>

        </div>
    </div>

    <script>
        // window.onload = function () {
        $(function () {
            $('.tab').on('click', function () {
                $('.tab, .panel').removeClass('active');
                $(this).addClass('active');
                var index = $('.tab').index(this);
                $('.panel').eq(index).addClass('active');
            });
        });

        // 選択ページ
        // カメラ・ギャラリー
        function snapPicture(mode) {
            var options;

            if (mode == "camera") {
                options = {
                    // 標準のカメラを起動
                    sourceType: Camera.PictureSourceType.CAMERA,
                    // データの形式
                    destinationType: Camera.DestinationType.DATA_URL
                }
            } else if (mode == "galary") {
                options = {
                    // ライブラリを起動
                    sourceType: Camera.PictureSourceType.PHOTOLIBRARY,
                    destinationType: Camera.DestinationType.DATA_URL
                }
            }

            // カメラ起動
            navigator.camera.getPicture(cameraSuccess, cameraError, options);

            function cameraSuccess(imageData) {
                var fileName = makeUUID() + ".jpg";
                var fileData = toBlob(imageData, "image/jpeg");

                // 撮影、選択した画像を画面に表示
                var img = document.querySelector("#photo");
                img.src = "data:image/jpeg;base64," + imageData;


                const image = new Image()
                image.src = img.src
                var ip

                let dst = document.getElementById("dst")
                dst.width = 300
                dst.height = 300

                image.onload = () => {
                    ip = new ImageProc(dst, image)
                    let element = document.getElementById('input');
                    element.value = ip.threshold;
                    let val = $('#input').val();
                    $('.value').html(val);
                    ip.threshold = ip.calcThreshold();
                    ip.convert();
                }

                $('.slider').on('input', function () {
                    let val = $(this).val();
                    $('.value').html(val);
                    var input_val = Number.parseInt(val);
                    ip.threshold = input_val;
                    ip.convert();
                });

                $('#reload_btn').on('click', function () {
                    ip.threshold = ip.calcThreshold();
                    ip.convert();
                    $('.value').html(ip.threshold);
                })

                // ip.drawOriginal()    元画像を表示する
                // ip.convert() //モノクローム画像に変換する
                // ip.threshold = 200   しきい値を200とする
                // ip.threshold = ip.calcThreshold()    計算したしきい値を指定する
            }

            function cameraError(message) {
                console.log(message)
            }

            // Blobを作成
            function toBlob(base64, mime_type) {
                var bin = atob(base64.replace(/^.*,/, ''));
                var buffer = new Uint8Array(bin.length);
                for (var i = 0; i < bin.length; i++) {
                    buffer[i] = bin.charCodeAt(i);
                }

                try {
                    console.log("ok")
                    var blob = new Blob([buffer.buffer], {
                        type: mime_type
                    });
                } catch (e) {
                    console.log("error");
                    return false;
                }
                return blob;
                console.log("blod" + blod);
            }

            // UUID生成
            function makeUUID() {
                var d = +new Date();
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'
                    .replace(/[xy]/g, function (c) {
                        var r = (d + Math.random() * 16) % 16 | 0;
                        return (c == 'x' ? r : (r & 0x3 | 0x8)).toString(16);
                    });
            }
        }
    </script>
</ons-page>